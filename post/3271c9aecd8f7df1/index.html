<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="AI-Agent,大模型,autogen,大模型,Autogen,管理系统,工作流,Autogen" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本文主要介绍了AutoGen的入门问题，如有错误请指正。">
<meta name="keywords" content="AI-Agent,大模型,autogen,大模型,Autogen,管理系统,工作流,Autogen">
<meta property="og:type" content="article">
<meta property="og:title" content="Autogen的基本框架,人工智能的管理系统——Autogen系列02">
<meta property="og:url" content="https://www.limoncc.com/post/3271c9aecd8f7df1/index.html">
<meta property="og:site_name" content="柠檬CC">
<meta property="og:description" content="本文主要介绍了AutoGen的入门问题，如有错误请指正。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.limoncc.com/images/Autogen基本框架.png">
<meta property="og:image" content="http://www.limoncc.com/images/Autogen可对话智能体实现.png">
<meta property="og:image" content="http://www.limoncc.com/images/Autogen如何运行.png">
<meta property="og:image" content="http://www.limoncc.com/images/puaai.png">
<meta property="og:image" content="https://www.limoncc.com/images/cc.png">
<meta property="og:image" content="https://www.limoncc.com/images/avatar.png">
<meta property="og:updated_time" content="2023-12-06T01:41:30.966Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Autogen的基本框架,人工智能的管理系统——Autogen系列02">
<meta name="twitter:description" content="本文主要介绍了AutoGen的入门问题，如有错误请指正。">
<meta name="twitter:image" content="http://www.limoncc.com/images/Autogen基本框架.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <title> Autogen的基本框架,人工智能的管理系统——Autogen系列02 | 柠檬CC </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-73837972-3', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d225b8f8559eb2eb6a8bd8792e01ebb9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60130136";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">柠檬CC</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">小白爱吃柠檬O(∩_∩)O</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-poetry">
          <a href="/poetry" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-leaf"></i> <br />
            
            诗集
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Autogen的基本框架,人工智能的管理系统——Autogen系列02
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2023-10-13T21:07:23+08:00" content="2023-10-13">
              2023-10-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/大模型应用开发/" itemprop="url" rel="index">
                    <span itemprop="name">大模型应用开发</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/post/3271c9aecd8f7df1/" class="leancloud_visitors" data-flag-title="Autogen的基本框架,人工智能的管理系统——Autogen系列02">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>作者: <a href="https://www.limoncc.com">引线小白</a>-本文永久链接：httpss://<a href="http://www.limoncc.com/post/3271c9aecd8f7df1/">www.limoncc.com/post/3271c9aecd8f7df1/</a><br>知识共享许可协议: 本博客采用<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external">署名-非商业-禁止演绎4.0</a>国际许可证</p>
<h4 id="一、一些基本介绍"><a href="#一、一些基本介绍" class="headerlink" title="一、一些基本介绍"></a>一、一些基本介绍</h4><p>下面引用autogen论文中观点，来说明<strong>为什么多智能体对话至关重要</strong>：</p>
<p>AutoGen Agents是可定制的、可对话的，并且无缝地允许人工参与。它们可以在各种模式下运行，这些模式采用 LLM、人工输入和工具的组合[^1]。AutoGen 的设计具有多种优势：<br>a） 它优雅地驾驭了LLM 强大但不完美的生成和推理能力<br>b） 它利用人类的理解和智慧，同时通过智能体之间的对话提供有价值的自动化<br>c） 它简化并统一了复杂的 LLM 工作流程作为自动智能体聊天的实现</p>
<p>尽管LLM-with-tools范式[^41]取得了显著的成功，但它通常使用单个LLM智能体。所谓三个臭皮匠顶个诸葛亮，未来LLM应用的一个有前途的方向是让多个智能体协同工作来解决复杂的任务。例如：<br>（1）引入更多的智能体来结合不同的角色，鼓励发散性思维[^29]，通过多智能体辩论提高LLM的事实性和推理能力[^16]等;<br>（2）允许有效的工具使用和执行，并通过代理间交互实现潜在的自主故障排除[^52];<br>（3）实现人的能动性等。</p>
<p>在这种多智能体系统中，智能体之间的对话将至关重要，使用语言（自然或代码）作为手段，通过潜在的多轮、来回消息交换来实现智能体协作。这些对话可以利用基于聊天的 LLM的能力来交流和整合来自人类层面的其他人的反馈。也就是说</p>
<p><a style="font-family:微软雅黑;font-size:15px;font-weight:bold;color:#FF3399">如果说传统开发是使用编程语言开发功能，而大模型应用开发则是使用自然语言和必要编程构建LLM能理解的中间语言(或者说领域特定语言)，通过沟通对话开发功能。</a></p>
<h4 id="二、autogen的基础类"><a href="#二、autogen的基础类" class="headerlink" title="二、autogen的基础类"></a>二、autogen的基础类</h4><p>一些约定：一开始笔者会说助理智能体(Assistant Agent)和人类代理智能体(User Proxy Agent)。后面为简洁记，笔者将直接说助理和代理，请注意这一点。</p>
<p>迅速理解autogen</p>
<p>最基础的类</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                     智能体(Agent)</span><br><span class="line">                            ｜</span><br><span class="line">                            ｜</span><br><span class="line">                可对话智能体(Conversable Agent)</span><br><span class="line">                            ｜</span><br><span class="line">                            ｜</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">   ｜                      ｜                    ｜                             </span><br><span class="line">助理智能体             人类代理智能体              群聊管理者</span><br><span class="line">Assistant Agent    User Proxy Agent     GroupChatManager</span><br></pre></td></tr></table></figure>
<p>如图所示：</p>
<p><img src="http://www.limoncc.com/images/Autogen基本框架.png" alt=""></p>
<p>下面来一一解析，我们的版本就autogen0.2.0，目前这个版本有较大幅度更新，和0.1.x有很大不同。大家注意版本, 同时由于比较新，所以你会看到很多注释都有(In preview)预览版字样。所以不排除以后更新较大。</p>
<h5 id="2-1、智能体-Agent-类"><a href="#2-1、智能体-Agent-类" class="headerlink" title="2.1、智能体(Agent)类"></a>2.1、智能体(Agent)类</h5><p>官方源码注释：</p>
<blockquote>
<p>(In preview) An abstract class for AI agent.<br>(预览版)智能体的抽象类。<br>An agent can communicate with other agents and perform actions.<br>一个智能体可以与其他智能体通信并执行操作。<br>Different agents can differ in what actions they perform in the receive method.<br>不同的代理在 <code>receive</code>方法中执行的操作可能不同。</p>
</blockquote>
<blockquote>
</blockquote>
<p>1、这个抽象类只有一个name属性<br>2、然后就是一些方法，其实就是怎么实现一个聊天有send(发送)、receive(接受)、generate_reply(生成回复)、reset(重置)这些方法，其中前三个方法是都有对应的异步方法。<br>3、既然是聊天就有message(消息)、sender(发送者)、recipient(接受者)、request_reply(是否请求回复)</p>
<h5 id="2-2、可对话智能体-ConversableAgent-类"><a href="#2-2、可对话智能体-ConversableAgent-类" class="headerlink" title="2.2、可对话智能体(ConversableAgent)类"></a>2.2、可对话智能体(ConversableAgent)类</h5><p>可对话智能体(ConversableAgent)类是autogen的核心类。稍微有点复杂，但是非常有必要掌握。因为对于复杂任务可能需要实现自己的可对话智能体。可对话智能体是集合了LLM、人类输入和工具的可定制智能体。<strong>AutoGen 的一个关键理念是将复杂工作流简化统一为智能体的自动化聊天</strong>。每个 Autogen 智能体都可以进行对话——它们可以接收、响应消息。开发人员可以使用 Autogen 构建有关对话自主性、智能体数量和对话拓扑的各种对话模式。</p>
<p><img src="http://www.limoncc.com/images/Autogen可对话智能体实现.png" alt=""></p>
<p>下面笔者来一一解析：</p>
<p>官方源码注释：</p>
<blockquote>
<p>(In preview) A class for generic conversable agents which can be configured as assistant or user proxy.<br>(预览版)一个通用的可对话智能体类，可以配置为助理智能体或人类代理智能体。<br>After receiving each message, the agent will send a reply to the sender unless the msg is a termination msg.<br>智能体接收到每条消息后，将向发送方发送回复，除非该消息是终止消息(termination msg)。<br>For example, AssistantAgent and UserProxyAgent are subclasses of this class, configured with different default settings.<br>例如，AssistantAgent和UserProxyAgent是这个类的子类， 配置了不同的默认设置。<br>To modify auto reply, override generate_reply method.<br>要修改自动回复，请重写<code>generate_reply</code>方法。<br>To disable/enable human response in every turn, set human_input_mode to “NEVER” or “ALWAYS”.<br>要在每个回合禁用/启用人工响应，请将<code>human_input_mode</code>设置为NEVER或ALWAYS。<br>To modify the way to get human input, override get_human_input method.<br>要修改获取人工输入的方式，请重写<code>get_human_input</code>方法。<br>To modify the way to execute code blocks, single code block, or function call, override execute_code_blocks, run_code, and execute_function methods respectively.<br>要修改执行代码块、单个代码块或函数调用，请重写<code>execute_code_blocks</code>，<code>run_code</code>和<code>execute_function</code>方法。<br> To customize the initial message when a conversation starts, override generate_init_message method.<br>要自定义对话开始时的初始消息，覆盖<code>generate_init_message</code>方法。</p>
</blockquote>
<p>初始化参数解析</p>
<blockquote>
</blockquote>
<ul>
<li><strong>name</strong>: 给代理起个名字</li>
<li><strong>system_message</strong>:系统提示词，默认为”You are a helpful AI Assistant.”</li>
<li><strong>is_termination_msg</strong>:一个函数用来判断是否终止：输入是一个字典，输出是一个布尔值。这个字典的key如下： “content”, “role”, “name”, “function_call”.</li>
<li><strong>max_consecutive_auto_reply</strong>: 最大连续自动回复次数</li>
<li><strong>human_input_mode</strong>:<br>取值为“ALWAYS”，“TERMINATE”，“NEVER”。<br>(1)当“ALWAYS”时，每次收到消息时，智能体都会提示人工输入。在此模式下，当人工输入“exit”时，对话停止，或者当is_termination_msg为True且没有人工输入时。<br>(2)当“TERMINATE”时，只有当接收到终止消息时或自动应答数达到max_consecutive_auto_reply，智能体才会提示人工输入。<br>(3)当“NEVER”时，代理将永远不会提示人工输入。在此模式下，当自动应答数达到max_consecutive_auto_reply或is_termination_msg为True时，对话停止。</li>
<li><strong>function_map</strong>: 将函数名(传递给openai)映射到可调用的函数。</li>
<li><strong>code_execution_config</strong>:<br>代码执行配置。<br>若要禁用代码执行，请设置为False。否则，将其设置为具有以下键的字典:<br>work_dir(可选): 代码执行的工作目录。如果为None，则使用默认的工作目录。默认的工作目录是extensions下面的path_to_autogen。<br>use_docker(可选，list, str或bool):用于代码执行的docker镜像。如果提供了镜像名称列表或str，则代码将在docker容器中执行成功拉出第一张图像。如果为None、False或empty，则代码将在当前环境中执行。当安装docker python包时，默认值为True。当设置为True时，将使用默认列表。我们强烈建议使用docker来执行代码。<br>timeout(可选，int):以秒为单位的最大执行时间。<br>last_n_messages(实验性的，可选的，int):代码执行时需要回头查看的消息数量。默认为1。<br>default_auto_reply: 当没有代码执行或基于llm的回复生成时，默认自动回复。</li>
<li><strong>llm_config</strong>: api配置</li>
<li><strong>default_auto_reply</strong>: 默认自动回复，默认值为空串””,</li>
</ul>
<h5 id="2-3、助理智能体-Assistant-Agent-和人类代理智能体-User-Proxy-Agent"><a href="#2-3、助理智能体-Assistant-Agent-和人类代理智能体-User-Proxy-Agent" class="headerlink" title="2.3、助理智能体(Assistant Agent)和人类代理智能体(User Proxy Agent)"></a>2.3、助理智能体(Assistant Agent)和人类代理智能体(User Proxy Agent)</h5><p>助理智能体(Assistant Agent)和人类代理智能体(User Proxy Agent)继承自可对话智能体(Conversable Agent)，它们的差别只差一个系统提示信息，且代理可以使用工具。</p>
<p>助理智能体(Assistant Agent)系统提示信息是</p>
<blockquote>
</blockquote>
<p>You are a helpful AI assistant.<br>Solve tasks using your coding and language skills.<br>In the following cases, suggest python code (in a python coding block) or shell script (in a sh coding block) for the user to execute.</p>
<pre><code>1. When you need to collect info, use the code to output the info you need, for example, browse or search the web, download/read a file, print the content of a webpage or a file, get the current date/time, check the operating system. After sufficient info is printed and the task is ready to be solved based on your language skill, you can solve the task by yourself.
2. When you need to perform some task with code, use the code to perform the task and output the result. Finish the task smartly.
</code></pre><p>Solve the task step by step if you need to. If a plan is not provided, explain your plan first. Be clear which step uses code, and which step uses your language skill.<br>When using code, you must indicate the script type in the code block. The user cannot provide any other feedback or perform any other action beyond executing the code you suggest. The user can’t modify your code. So do not suggest incomplete code which requires users to modify. Don’t use a code block if it’s not intended to be executed by the user.<br>If you want the user to save the code in a file before executing it, put # filename: <filename> inside the code block as the first line. Don’t include multiple code blocks in one response. Do not ask users to copy and paste the result. Instead, use ‘print’ function for the output when relevant. Check the execution result returned by the user.<br>If the result indicates there is an error, fix the error and output the code again. Suggest the full code instead of partial code or code changes. If the error can’t be fixed or if the task is not solved even after the code is executed successfully, analyze the problem, revisit your assumption, collect additional info you need, and think of a different approach to try.<br>When you find an answer, verify the answer carefully. Include verifiable evidence in your response if possible.<br>Reply “TERMINATE” in the end when everything is done.</filename></p>
<p>翻译一下</p>
<blockquote>
</blockquote>
<p>你是一个有用的人工智能助手。<br>用你的编程和语言技能解决任务。<br>在以下情况下，建议使用python代码(在python编码块中)或shell脚本(在sh编码块中)供用户执行。 </p>
<ol>
<li>当您需要收集信息时，使用代码输出您需要的信息，例如，浏览或搜索网页，下载/读取文件，打印网页或文件的内容，获取当前日期/时间，检查操作系统。在打印出足够的信息，并根据你的语言能力准备好解决任务后，你就可以自己解决任务了。 </li>
<li>当您需要用代码执行某些任务时，请使用代码来执行任务并输出结果。聪明地完成任务。<br>如果需要的话，一步一步地解决这个任务。如果没有提供计划，首先解释你的计划。明确哪一步使用代码，哪一步使用你的语言技能。<br>使用代码时，必须在代码块中指示脚本类型。除了执行您建议的代码之外，用户不能提供任何其他反馈或执行任何其他操作。用户不能修改你的代码。所以不要建议用户修改不完整的代码。不要使用不打算由用户执行的代码块。<br>如果您希望用户在执行代码之前将代码保存在一个文件中，请将# filename: <filename>放在代码块中作为第一行。不要在一个响应中包含多个代码块。不要要求用户复制和粘贴结果。相反，在相关的时候使用’print’函数输出。查看用户返回的执行结果。<br>如果结果表明存在错误，则修复错误并再次输出代码。建议使用完整的代码，而不是部分代码或代码更改。如果错误无法修复，或者即使成功执行了代码，任务也没有解决，那么就分析问题，重新审视您的假设，收集所需的其他信息，然后考虑另一种尝试方法。<br>当你找到答案时，仔细核实答案。如果可能的话，在你的回答中包括可证实的证据。<br>当一切都完成后，最后回复“TERMINATE”。</filename></li>
</ol>
<p>而人类代理智能体(User Proxy Agent)的系统提示信息与可对话智能体(Conversable Agent)是一样的</p>
<blockquote>
<p>You are a helpful AI Assistant.</p>
</blockquote>
<p>翻译就是</p>
<blockquote>
<p>你是一个有用的人工智能助手。 </p>
</blockquote>
<p>它们的主要功能：</p>
<p><strong>Assistant Agent</strong></p>
<p>1、充当AI助手，默认情况下使用LLM，但不需要人工输入或代码执行。<br>2、它可以编写Python代码（在Python编码块中），供用户在收到消息（通常是需要解决的任务的描述）时执行。<br>3、在引擎盖下，Python代码由LLM编写（例如GPT-4）。它还可以接收执行结果并建议更正或错误修复。可以通过传递新的系统消息来更改其行为。LLM 推理配置可以通过 llm_config 进行配置。</p>
<p><strong>User Proxy Agent</strong></p>
<p>1、默认情况下在每个交互回合时，代理的回复都会征求人类输入，并且还具有执行代码和调用函数的能力。<br>2、当它检测到收到的消息中存在可执行代码块并且未提供人工用户输入时，它会自动 UserProxyAgent 触发代码执行。可以通过将 code_execution_config 参数设置为 False 来禁用代码执行。<br>3、默认情况下，基于 LLM 的响应处于禁用状态。可以通过设置为 llm_config 与推理配置对应的字典来启用它。当设置为字典时 llm_config ， UserProxyAgent 可以在不执行代码执行时使用LLM生成回复。<br>4、自动回复功能允许更自主的 ConversableAgent 多代理通信，同时保留人为干预的可能性。还可以通过使用该方法 register_reply() 注册回复函数来轻松扩展它</p>
<h4 id="三、对话是如何运行的？"><a href="#三、对话是如何运行的？" class="headerlink" title="三、对话是如何运行的？"></a>三、对话是如何运行的？</h4><p>对于一对一对话而言，会使用人类代理智能体(User Proxy Agent)实例调用initiate_chat方法开始对话。具体机制如图：</p>
<p><img src="http://www.limoncc.com/images/Autogen如何运行.png" alt=""></p>
<p>下面来详细探究一下initiate_chat的机制，该函数有如下<br><strong>输入：</strong></p>
<blockquote>
</blockquote>
<p>recipient: 接收者(智能体)，顾名思义就是人类代理给谁发信息。<br>clear_history: 一个布尔值，默认为True，清空历史<br>silent: 一个布尔，默认为False，不静默，打印消息<br>**context: 一个字典，如果自己没有实现generate_init_message，则必须有message。</p>
<p><strong>过程：代理使用接收者(助理)初始化对话</strong></p>
<blockquote>
</blockquote>
<p>1、代理准备对话<br>==&gt;1.1、设定记录对话数(接收者、代理)<br>==&gt;1.2、设定助理、代理的reply_at_receive(收到时回复)为Ture<br>==&gt;1.3、如果clear_history=True，则清空接收者、代理历史记录<br>2、代理发送生成的初始化消息给接受者<br>==&gt;2.1、生成初始消息<br>==&gt;2.2、添加OAI消息<br>==&gt;2.3、接受者接受消息<br>3、接受者处理收到的消息<br>==&gt;3.1、处理收到的消息<br>==&gt;3.2、生成回复消息<br>==&gt;3.3、发送生成的消息给代理<br>接下来就是反复使用send方法直到满足终止或最大化对话数。</p>
<p>对着源代码然后在，反复看几篇应该不难理解。</p>
<h4 id="四、构建复杂的多智能体对话系统"><a href="#四、构建复杂的多智能体对话系统" class="headerlink" title="四、构建复杂的多智能体对话系统"></a>四、构建复杂的多智能体对话系统</h4><p>构建复杂的多智能体对话系统涉及两点</p>
<blockquote>
</blockquote>
<p>（a） 定义一组具有专门功能和角色的可对话智能体<br>（b） 定义智能体之间的交互行为，即一个智能体在接收来自另一个智能体的消息时应如何响应。</p>
<p>通过统一对话界面进行多智能体对话。Autogen通过自动回复机制提供了一种分散的、模块化的和统一的方式来定义工作流程。可以注册自定义的自动回复功能（由generate_reply根据注册条件触发）来定义代理的行为模式，例如，在回复之前使用LLM、工具或与其他智能体聊天。如果开发人员需要将其他智能体引入现有智能体工作流，则开发人员只需对添加的智能体进行编程，并修改可能与之对话的智能体。</p>
<p>这里首先要区分一下静态对话和动态对话的概念。其实质是一群人应该如何聊天的问题？可以指定发言顺序、或者投骰子随机选择下一位、或者提供上下文信息让LLM来选择。</p>
<h5 id="4-1、群组聊天类-GroupChat"><a href="#4-1、群组聊天类-GroupChat" class="headerlink" title="4.1、群组聊天类(GroupChat)"></a>4.1、群组聊天类(GroupChat)</h5><p>autogen的<code>GroupChat</code>类就是解决如何群聊的一部分，它的输入参数如下：</p>
<p>(预览版) 群组聊天类，包含以下数据字段:<br><strong>agents</strong></p>
<blockquote>
<p>参与智能体名单</p>
</blockquote>
<p><strong>messages</strong></p>
<blockquote>
<p>群组聊天中的消息列表。</p>
</blockquote>
<p><strong>max_round</strong></p>
<blockquote>
<p>最大回合数。</p>
</blockquote>
<p><strong>admin_name</strong></p>
<blockquote>
<p>管理智能体的名称(如果有的话)。默认为“Admin”。KeyBoardInterrupt将使管理智能体被人类接管。</p>
</blockquote>
<p><strong>func_call_filter</strong></p>
<blockquote>
<p>是否强制函数调用筛选。默认为True。 当设置为True并且消息是函数调用建议时，下一个发言人将从一个智能体中选择，该智能体在其’ function_map ‘中包含相应的函数名称。</p>
</blockquote>
<p><strong>speaker_selection_method</strong></p>
<blockquote>
</blockquote>
<p>选择下一位发言者的方法。默认为auto。 可以是以下任何一种(不区分大小写)，如果未被识别将引发ValueError: </p>
<ul>
<li>auto:LLM自动选择下一位演讲者。 </li>
<li>manual:由人类手动选择下一位发言者。 </li>
<li>random:随机选择下一位发言者。 </li>
<li>round_robin:以轮询方式选择下一个发言者，即按照agents中提供的相同顺序迭代。</li>
</ul>
<p>这里指的关注一下auto是怎么实现的，其实就是有一个prompt模版，拼接了上下文信息和agent的system_message消息，然后让群聊管理员来选择下一个发言者。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">messages+<span class="string">f"""You are in a role play game. The following roles are available:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;agent.name&#125;</span>: <span class="subst">&#123;agent.system_message&#125;</span>.</span></span><br><span class="line"><span class="string">Read the following conversation.</span></span><br><span class="line"><span class="string">Then select the next role from <span class="subst">&#123;[agent.name <span class="keyword">for</span> agent <span class="keyword">in</span> agents]&#125;</span> to play. Only return the role."""</span></span><br></pre></td></tr></table></figure></p>
<p><strong>allow_repeat_speaker</strong></p>
<blockquote>
<p>是否允许同一发言人连续发言。默认为True.</p>
</blockquote>
<h5 id="4-2、群聊管理员-GroupChatManager"><a href="#4-2、群聊管理员-GroupChatManager" class="headerlink" title="4.2、群聊管理员(GroupChatManager)"></a>4.2、群聊管理员(GroupChatManager)</h5><p>正如上文所示，群聊管理员继承自可对话智能体，唯一的区别就两点</p>
<p>1、system_message：”Group chat manager.”</p>
<p>2、run_chat方法，当然也有对应的异步a_run_chat方法，用于运行一个群组聊天</p>
<h4 id="五、评述"><a href="#五、评述" class="headerlink" title="五、评述"></a>五、评述</h4><p>1、本文主要是理论介绍，读完应该会对autogen的基本框架有一个基本印象。<br>2、在AI agent落地的实践中，人们发现多智能体对话处于核心地位，于是如何组织对话就成为了框架的核心机制。<br>3、AutoGen通过回复函数机制：</p>
<ul>
<li>1、有一个可注册的回复函数列表</li>
<li>2、通过generate_reply来开控制回复</li>
</ul>
<blockquote>
</blockquote>
<p>默认情况下，按顺序检查以下函数: </p>
<ol>
<li>check_termination_and_human_reply </li>
<li>generate_function_call_reply </li>
<li>generate_code_execution_reply </li>
<li><p>generate_oai_reply</p>
<ul>
<li>3、聊天必备的send(发送)、receive(接受)、generate_reply(生成回复)、reset(重置)方法</li>
</ul>
</li>
</ol>
<p>通过这样一套机制解决了静态对话，动态对话、工作流编排等一系列问题，本文并没有举例，稍微动脑不难实现，Autogen也提供了大量例子。有进一步阅读兴趣可以参考<a href="https://github.com/microsoft/autogen/tree/main/notebook" target="_blank" rel="noopener">notebook</a>。<strong>Autogen其实质不过是把人类的管理系统移植到AI上</strong>，所以要水论文，可以<strong>把管理学的理论移植到LLM上做一遍，应该可以发大量论文出来。</strong></p>
<p>4、如何组织管理多智能体，目前有了一个良好的开端，但是AutoGen也是有大量问题的</p>
<ul>
<li>1、prompt和智能体没有解耦，当然这样做也是很容易的</li>
<li>2、探索适合LLM的管理思想也许会诞生一门新的学问：<strong>人工智能管理学</strong>：如何设定AI角色、如何组织AI群聊工作、如何监控AI工作绩效，乃至如何提高AI管理绩效</li>
<li>3、人类社会有ERP，人工智能世界是不是也要有一套ERP，也许Autogen只是一个开端而已。</li>
</ul>
<p>5、在解决了agent是什么后，如何<strong>提高智能体管理绩效</strong>应该是Agent框架的核心议题。所以PUA AI 你会吗[^2]？EP 07 那句话阿里味都溢出来了，是不是！向AI要管理绩效可不是说着玩玩。</p>
<p><img src="http://www.limoncc.com/images/puaai.png" alt=""></p>
<p>6、如何设定AI角色，如何让智能体成为高绩效员工应该是大模型的一下一个议题之一。</p>
<p>所以未来还有很多工作，大家保持关注。一下篇文章已经有了：</p>
<p>大模型时代的交互语言——Autogen系列03，本文详细讨论了大模型时代应该如何交互的问题。</p>
<p>欢迎加入AutogenQQ交流群：593623958</p>
<p>[^1]: Wu, Q., Bansal, G., Zhang, J., Wu, Y., Li, B., Zhu, E., et al. (2023, October 3). AutoGen: Enabling Next-Gen LLM Applications via Multi-Agent Conversation. arXiv. <a href="http://arxiv.org/abs/2308.08155" target="_blank" rel="noopener">http://arxiv.org/abs/2308.08155</a>. Accessed 5 December 2023</p>
<p>[^2]: Li, C., Wang, J., Zhang, Y., Zhu, K., Hou, W., Lian, J., et al. (n.d.). Large Language Models Understand and Can Be Enhanced by Emotional Stimuli.</p>
<p><hr></p>
<p><table border="1" width="100%"><tr><td align="center" width="18%">版权声明</td><td align="left" width="82%"><img src="https://www.limoncc.com/images/cc.png" width="18%"></td></tr><tr><td align="center" width="18%"><img src="https://www.limoncc.com/images/avatar.png" width="100%"></td><td align="left" width="82%">由<a href="https://www.limoncc.com">引线小白</a>创作并维护的<a href="http://www.limoncc.com">柠檬CC</a>博客采用<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external">署名-非商业-禁止演绎4.0</a>国际许可证。<br>本文首发于柠檬CC <a href="https://www.limoncc.com">[ https://www.limoncc.com ]</a> , 版权所有、侵权必究。</td></tr><tr><td align="center" width="18%">本文永久链接</td><td align="left" width="82%">httpss://<a href="http://www.limoncc.com/post/3271c9aecd8f7df1/">www.limoncc.com/post/3271c9aecd8f7df1/</a></td></tr></table><table border="0" width="100%" style="display:inline !important;font-size:14px !important;color:#555555;"><tr><td align="left" width="100%" style="font-family:helvetica;font-size:14px !important;font-weight:bold;">如果您需要引用本文，请参考：</td></tr><tr><td align="left" width="100%">引线小白. (Oct. 13, 2023). 《Autogen的基本框架,人工智能的管理系统——Autogen系列02》[Blog post]. Retrieved from <a href="https://www.limoncc.com/post/3271c9aecd8f7df1">https://www.limoncc.com/post/3271c9aecd8f7df1</a></td></tr><tr><td align="left" width="100%">@online{limoncc-3271c9aecd8f7df1,<br>title={Autogen的基本框架,人工智能的管理系统——Autogen系列02},<br>author={引线小白},<br>year={2023},<br>month={Oct},<br>date={13},<br>url={\url{<a href="https://www.limoncc.com/post/3271c9aecd8f7df1}}">https://www.limoncc.com/post/3271c9aecd8f7df1}}</a>,<br>}</td></tr></table><div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_duitang" data-cmd="duitang" title="分享到堆糖"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a></div></p>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{},"image":{"viewList":["tsina","douban","weixin","sqq","duitang","qzone","fbook","twi"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","douban","weixin","sqq","duitang","qzone","fbook","twi"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/生成模型/" rel="tag">#生成模型</a>
          
            <a href="/tags/AI-Agent/" rel="tag">#AI-Agent</a>
          
            <a href="/tags/autogen/" rel="tag">#autogen</a>
          
            <a href="/tags/工作流/" rel="tag">#工作流</a>
          
            <a href="/tags/大模型/" rel="tag">#大模型</a>
          
            <a href="/tags/管理系统/" rel="tag">#管理系统</a>
          
            <a href="/tags/基本框架/" rel="tag">#基本框架</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/a0fe24f2ca704c1e/" rel="next" title="初见AI-Agent——Autogen系列01">
                <i class="fa fa-chevron-left"></i> 初见AI-Agent——Autogen系列01
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/b6e87fb18befa699/" rel="prev" title="大模型时代的交互语言——Autogen系列03">
                大模型时代的交互语言——Autogen系列03 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


<!--           </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div> -->
        <div id="vcomments"></div>
        <script>new Valine({
          el: "#vcomments",
      appId: "BVjuNRCpkVSkz82jFmadIvY8-gzGzoHsz",
    appKey: "bRjXPp55dop7RTC2xgunGdiP"})
  </script>'
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="引线小白" />
          <p class="site-author-name" itemprop="name">引线小白</p>
          <p class="site-description motion-element" itemprop="description">小湖椰影廊桥,曾记否,谷围晓月,灯影朦胧。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">46</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="" target="_blank" title="Design">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Design
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="https://www.behance.net/limoncc" target="_blank" title="Behance">
                  
                    <i class="fa fa-fw fa-behance"></i>
                  
                  Behance
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="https://www.pinterest.com/aegeanfan/" target="_blank" title="Pinterest">
                  
                    <i class="fa fa-fw fa-pinterest"></i>
                  
                  Pinterest
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="https://github.com/limoncc" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="http://weibo.com/3483157951" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a rel="external nofollow" href="http://www.zhihu.com/people/limoncc" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              设计不止，折腾不息。
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://chuangzaoshi.com" title="创造狮" target="_blank">创造狮</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#一、一些基本介绍"><span class="nav-number">1.</span> <span class="nav-text">一、一些基本介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二、autogen的基础类"><span class="nav-number">2.</span> <span class="nav-text">二、autogen的基础类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1、智能体-Agent-类"><span class="nav-number">2.1.</span> <span class="nav-text">2.1、智能体(Agent)类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2、可对话智能体-ConversableAgent-类"><span class="nav-number">2.2.</span> <span class="nav-text">2.2、可对话智能体(ConversableAgent)类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3、助理智能体-Assistant-Agent-和人类代理智能体-User-Proxy-Agent"><span class="nav-number">2.3.</span> <span class="nav-text">2.3、助理智能体(Assistant Agent)和人类代理智能体(User Proxy Agent)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三、对话是如何运行的？"><span class="nav-number">3.</span> <span class="nav-text">三、对话是如何运行的？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四、构建复杂的多智能体对话系统"><span class="nav-number">4.</span> <span class="nav-text">四、构建复杂的多智能体对话系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1、群组聊天类-GroupChat"><span class="nav-number">4.1.</span> <span class="nav-text">4.1、群组聊天类(GroupChat)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2、群聊管理员-GroupChatManager"><span class="nav-number">4.2.</span> <span class="nav-text">4.2、群聊管理员(GroupChatManager)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五、评述"><span class="nav-number">5.</span> <span class="nav-text">五、评述</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">引线小白&nbsp &nbsp |&nbsp &nbsp  一个理想主义者，再造自我，以期未来。</span>
</div>

<div class="powered-by">
  由 <a rel="external nofollow" class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a rel="external nofollow" class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>&nbsp &nbsp| &nbsp &nbsp Hosted by  <a href="https://github.com" style="font-weight: bold">Github Pages</a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



<!--   
   
  

  

 -->
  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  
<!--   <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
     showMathMenu: false,
     showMathMenuMSIE: false,
     tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
          processEscapes: true
        },
        TeX: {
          equationNumbers: {autoNumber: 'AMS'},
          Macros: {bm: "\\boldsymbol"}
        },
        'HTML-CSS': {
          imageFont: null
        }
    });
  </script> -->
<!--     MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    }); -->
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
    processEscapes: true,
    tags: 'ams',
    macros: {
                                            bm: "\\boldsymbol",
					    T:"\\intercal",
                                            oiint: "{\\iint\\kern{-20mu}{\\unicode{x2B2D}}}",
                                            oiiint: "{\\iiint\\kern{-24.5mu}\\large{\\unicode{x2B2D}}}"
                                },
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
  <script type="text/x-mathjax-config">
MathJax.texReset();
MathJax.typeset();
  </script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_SVG-full"></script> -->


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Es7wAnqi0QiGhMLoyl7mkrQo-gzGzoHsz", "BxPXaoPFp3PzWqBTSe6VUuQS");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</body>
</html>
